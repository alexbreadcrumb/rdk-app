<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Drive Notes — Alejandro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;max-width:900px;margin:20px auto;padding:12px}
    header{display:flex;align-items:center;gap:12px}
    button{padding:8px 10px;margin:4px}
    #files{margin-top:12px}
    textarea{width:100%;height:240px;margin-top:8px;font-family:monospace}
    .file-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed #ddd}
    .small{font-size:0.9rem;color:#555}
  </style>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header>
    <h2>Drive Notes (demo)</h2>
    <div style="margin-left:auto">
      <button id="btnSignIn">Iniciar sesión</button>
      <button id="btnSignOut" style="display:none">Cerrar sesión</button>
    </div>
  </header>

  <p class="small">Demo simple: guarda/recupera notas de texto en un archivo <code>.db</code> dentro de tu Google Drive.</p>

  <section>
    <button id="btnEnsure">Asegurar NOTE.db (crear si no existe)</button>
    <button id="btnList">Listar .db</button>
    <button id="btnNewNote">Agregar nota (append)</button>
  </section>

  <div id="status" class="small" style="margin-top:8px;color:green"></div>

  <div id="files"></div>

  <h3>Editor</h3>
  <div class="small">Archivo: <span id="curName">-</span></div>
  <textarea id="editor" placeholder="Abre un archivo .db para editar (demo: texto plano)"></textarea>
  <div style="margin-top:6px">
    <button id="btnSave" disabled>Guardar (sobrescribir)</button>
    <button id="btnAppendSave" disabled>Guardar + conservar (append)</button>
  </div>

<script>
/* CONFIG: reemplazar por tu Client ID */
const CLIENT_ID = '576080826935-2mtnj52ndc8plnsjodjevt3e2gsh4m3a.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly';

let tokenClient = null;
let accessToken = null;

/* UI */
function showStatus(msg, isError=false){ const s=document.getElementById('status'); s.style.color = isError ? 'crimson' : 'green'; s.textContent = msg; }

/* Inicializa Google token client */
window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (resp) => {
      if (resp.error) { showStatus('Error token: '+resp.error, true); return; }
      accessToken = resp.access_token;
      document.getElementById('btnSignIn').style.display = 'none';
      document.getElementById('btnSignOut').style.display = 'inline-block';
      showStatus('Conectado a Google Drive.');
    }
  });

  document.getElementById('btnSignIn').onclick = () => tokenClient.requestAccessToken({prompt:'consent'});
  document.getElementById('btnSignOut').onclick = signOut;

  document.getElementById('btnEnsure').onclick = ensureNoteDb;
  document.getElementById('btnList').onclick = listDbFiles;
  document.getElementById('btnNewNote').onclick = addNoteAppend;

  document.getElementById('btnSave').onclick = saveCurrentFile;
  document.getElementById('btnAppendSave').onclick = saveCurrentFileAppend;
};

/* Sign out simple (limpia token local) */
function signOut(){
  accessToken = null;
  document.getElementById('btnSignIn').style.display = 'inline-block';
  document.getElementById('btnSignOut').style.display = 'none';
  document.getElementById('files').innerHTML = '';
  document.getElementById('editor').value = '';
  document.getElementById('curName').textContent = '-';
  document.getElementById('btnSave').disabled = true;
  document.getElementById('btnAppendSave').disabled = true;
  showStatus('Sesión cerrada.');
}

/* wrapper fetch con token */
async function driveFetch(url, opts={}){
  if(!accessToken) throw new Error('No logueado');
  opts.headers = opts.headers || {};
  opts.headers['Authorization'] = 'Bearer ' + accessToken;
  return fetch(url, opts);
}

/* Asegura NOTE.db (crea si no existe) */
async function ensureNoteDb(){
  try{
    showStatus('Buscando NOTE.db...');
    const q = `name = 'NOTE.db' and trashed = false`;
    const r = await driveFetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)&pageSize=1`);
    const j = await r.json();
    if(j.files && j.files.length>0){
      showStatus('NOTE.db encontrado. id: '+j.files[0].id);
      listDbFiles();
      return;
    }
    showStatus('Creando NOTE.db...');
    const metadata = { name: 'NOTE.db' };
    const content = 'NOTES\n\nCreado: ' + new Date().toISOString() + '\n\n';
    const boundary = '-------314159265358979323846';
    const delimiter = '\\r\\n--' + boundary + '\\r\\n';
    const close_delim = '\\r\\n--' + boundary + '--';
    const body =
      delimiter +
      'Content-Type: application/json; charset=UTF-8\\r\\n\\r\\n' +
      JSON.stringify(metadata) +
      delimiter +
      'Content-Type: text/plain\\r\\n\\r\\n' +
      content +
      close_delim;
    const create = await driveFetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method:'POST',
      headers:{ 'Content-Type':'multipart/related; boundary=' + boundary },
      body: body
    });
    const created = await create.json();
    if(created.id) showStatus('NOTE.db creado id: '+created.id);
    else showStatus('NOTE.db creado (respuesta inesperada)', false);
    listDbFiles();
  }catch(err){ console.error(err); showStatus('Error: '+err.message, true); }
}

/* Lista archivos .db */
async function listDbFiles(){
  try{
    showStatus('Listando .db...');
    const q = `name contains '.db' and trashed = false`;
    const fields = 'files(id,name,modifiedTime,size)';
    const r = await driveFetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${encodeURIComponent('files(' + fields + ')')}&pageSize=50`);
    const j = await r.json();
    const cont = document.getElementById('files');
    cont.innerHTML = '';
    if(!j.files || j.files.length===0){ cont.innerHTML = '<div class="small">No se encontraron .db</div>'; showStatus('0 archivos .db'); return; }
    j.files.forEach(f=>{
      const div = document.createElement('div');
      div.className = 'file-row';
      div.innerHTML = `<div><strong>${escapeHtml(f.name)}</strong><div class="small">id: ${f.id} — ${f.size||'—'} bytes</div></div>`;
      const btnOpen = document.createElement('button'); btnOpen.textContent='Abrir'; btnOpen.onclick = ()=> openFile(f);
      const btnDL = document.createElement('button'); btnDL.textContent='Descargar'; btnDL.onclick = ()=> downloadFile(f);
      div.appendChild(btnOpen); div.appendChild(btnDL);
      cont.appendChild(div);
    });
    showStatus('Encontrados ' + j.files.length + ' archivos .db');
  }catch(err){ console.error(err); showStatus('Error listar: '+err.message, true); }
}

/* Abrir archivo (muestra en textarea) */
async function openFile(file){
  try{
    showStatus('Abriendo '+file.name+' ...');
    const r = await driveFetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`);
    if(!r.ok) throw new Error('Error download: ' + r.status);
    const text = await r.text();
    document.getElementById('editor').value = text;
    document.getElementById('curName').textContent = file.name;
    document.getElementById('curName').dataset.id = file.id;
    document.getElementById('btnSave').disabled = false;
    document.getElementById('btnAppendSave').disabled = false;
    showStatus('Archivo cargado.');
  }catch(err){ console.error(err); showStatus('Error abrir: '+err.message, true); }
}

/* Descargar archivo localmente */
async function downloadFile(file){
  try{
    showStatus('Descargando '+file.name+' ...');
    const r = await driveFetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`);
    if(!r.ok) throw new Error('Error download: '+r.status);
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = file.name; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    showStatus('Descarga iniciada.');
  }catch(err){ console.error(err); showStatus('Error descarga: '+err.message, true); }
}

/* Guardar (sobrescribir) archivo abierto */
async function saveCurrentFile(){
  try{
    const id = document.getElementById('curName').dataset.id;
    if(!id) { showStatus('No hay archivo abierto', true); return; }
    showStatus('Guardando...');
    const content = document.getElementById('editor').value;
    const r = await driveFetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'text/plain' },
      body: content
    });
    if(!r.ok) throw new Error('Fallo guardar: ' + r.status);
    const updated = await r.json();
    showStatus('Guardado OK. id: ' + updated.id);
  }catch(err){ console.error(err); showStatus('Error guardar: '+err.message, true); }
}

/* Guardar + conservar (append): descarga, concatena y vuelve a subir */
async function saveCurrentFileAppend(){
  try{
    const id = document.getElementById('curName').dataset.id;
    if(!id) { showStatus('No hay archivo abierto', true); return; }
    showStatus('Appending (descargando primero)...');
    const r1 = await driveFetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`);
    if(!r1.ok) throw new Error('Error download: ' + r1.status);
    const existing = await r1.text();
    const toSave = existing + '\n' + document.getElementById('editor').value;
    const r2 = await driveFetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
      method:'PATCH',
      headers:{ 'Content-Type':'text/plain' },
      body: toSave
    });
    if(!r2.ok) throw new Error('Error upload: ' + r2.status);
    const updated = await r2.json();
    showStatus('Append guardado. id: '+updated.id);
  }catch(err){ console.error(err); showStatus('Error append: '+err.message, true); }
}

/* Agregar nota rápida: si no hay NOTE.db, lo crea; luego lo abre y agrega texto */
async function addNoteAppend(){
  try{
    // asegurar NOTE.db
    await ensureNoteDb();
    // buscar NOTE.db y abrirlo
    const q = `name = 'NOTE.db' and trashed = false`;
    const r = await driveFetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)&pageSize=1`);
    const j = await r.json();
    if(j.files && j.files.length>0){
      const f = j.files[0];
      await openFile(f);
      // agregar una línea de ejemplo
      const ed = document.getElementById('editor');
      ed.value = ed.value + '\\n[Nota ' + new Date().toLocaleString() + '] ';
      // auto-guardamos (append flow)
      await saveCurrentFile();
    } else showStatus('No se encontró NOTE.db tras crear (raro).', true);
  }catch(err){ console.error(err); showStatus('Error addNote: '+err.message, true); }
}

/* Helpers */
function escapeHtml(s){ return s? s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) : ''; }
</script>
</body>
</html>
