<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Llavero Minimalista</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#4A90E2; color:#fff; padding:15px; text-align:center; font-size:1.2em; }
.container { padding:10px; max-width:500px; margin:auto; }
input, select, textarea, button { width:100%; padding:8px; margin:5px 0; box-sizing:border-box; }
button { background:#4A90E2; color:#fff; border:none; cursor:pointer; }
button:hover { background:#357ABD; }
.key-item { background:#fff; padding:10px; margin:5px 0; border-radius:5px; }
.flex { display:flex; gap:5px; }
.flex button { flex:1; }
.tag { display:inline-block; background:#ddd; padding:2px 6px; margin:2px; border-radius:4px; }
.hidden { display:none; }
</style>
</head>
<body>
<header>Llavero Personal Minimalista</header>
<div class="container">

<!-- Login -->
<div id="loginDiv">
  <button id="googleSignInBtn">Iniciar sesión con Google</button>
</div>

<!-- Main Panel -->
<div id="mainDiv" class="hidden">

<h3>Archivos Llavero</h3>
<div id="dbList"></div>
<input type="text" id="newDbName" placeholder="Nombre nuevo archivo .db">
<input type="password" id="masterKey" placeholder="Clave maestra">
<button id="createDbBtn">Crear / Abrir</button>
<button id="logoutBtn">Cerrar sesión</button>

<hr>

<input type="text" id="searchKey" placeholder="Buscar por nombre o nota">
<div id="keyList"></div>

<h4>Agregar / Editar llave</h4>
<input type="text" id="keyName" placeholder="Nombre de llave">
<input type="text" id="keyUser" placeholder="Usuario / Mail">
<input type="text" id="keyPass" placeholder="Clave">
<textarea id="keyNote" placeholder="Nota"></textarea>
<input type="text" id="keyTags" placeholder="Etiquetas (separadas por coma)">
<div class="flex">
  <button id="saveKeyBtn">Guardar</button>
  <button id="cancelEditBtn">Cancelar</button>
</div>

</div>
</div>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
let CLIENT_ID = '576080826935-2mtnj52ndc8plnsjodjevt3e2gsh4m3a.apps.googleusercontent.com';
let SCOPES = 'https://www.googleapis.com/auth/drive.file';
let dbData = null;
let dbFileId = null;
let masterKeyGlobal = '';
let sessionTimer = null;

// --- GOOGLE LOGIN ---
function start() {
  gapi.load('client:auth2', initClient);
}

function initClient() {
  gapi.auth2.init({client_id: CLIENT_ID}).then(() => {
    document.getElementById('googleSignInBtn').onclick = signIn;
  });
}

function signIn() {
  gapi.auth2.getAuthInstance().signIn().then(() => {
    gapi.client.load('drive', 'v3', loadDbList);
    document.getElementById('loginDiv').classList.add('hidden');
    document.getElementById('mainDiv').classList.remove('hidden');
  });
}

function logout() {
  gapi.auth2.getAuthInstance().signOut().then(() => location.reload());
}

document.getElementById('logoutBtn').onclick = logout;

// --- DB HANDLING ---
async function loadDbList() {
  const res = await gapi.client.drive.files.list({
    q: "mimeType='application/octet-stream' and trashed=false",
    fields: "files(id,name)"
  });
  const list = res.result.files;
  const dbListDiv = document.getElementById('dbList');
  dbListDiv.innerHTML = '';
  list.forEach(f => {
    const btn = document.createElement('button');
    btn.textContent = f.name;
    btn.onclick = () => openDb(f.id, f.name);
    dbListDiv.appendChild(btn);
  });
}

async function createDb() {
  const name = document.getElementById('newDbName').value.trim();
  const key = document.getElementById('masterKey').value;
  if(!name || !key) return alert('Ingrese nombre y clave maestra');
  masterKeyGlobal = key;
  dbData = { keys: [] };
  const content = CryptoJS.AES.encrypt(JSON.stringify(dbData), key).toString();
  const fileMetadata = { name: name + '.db', mimeType: 'application/octet-stream' };
  const file = new Blob([content], {type:'application/octet-stream'});
  const res = await gapi.client.drive.files.create({ resource:fileMetadata, media: { body: file }, fields:'id' });
  dbFileId = res.result.id;
  renderKeys();
  resetSessionTimer();
}

async function openDb(fileId, fileName) {
  const key = prompt('Ingrese clave maestra para ' + fileName);
  if(!key) return;
  masterKeyGlobal = key;
  const res = await gapi.client.drive.files.get({ fileId:fileId, alt:'media' });
  try {
    const bytes = CryptoJS.AES.decrypt(res.body, key);
    dbData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
    dbFileId = fileId;
    renderKeys();
    resetSessionTimer();
  } catch(e) { alert('Clave incorrecta'); }
}

// --- ABM KEYS ---
function renderKeys(filter='') {
  const listDiv = document.getElementById('keyList');
  listDiv.innerHTML = '';
  dbData.keys.filter(k => k.name.includes(filter) || (k.note && k.note.includes(filter))).forEach((k,i)=>{
    const div = document.createElement('div'); div.className='key-item';
    const user = CryptoJS.AES.decrypt(k.user, masterKeyGlobal).toString(CryptoJS.enc.Utf8);
    const pass = CryptoJS.AES.decrypt(k.pass, masterKeyGlobal).toString(CryptoJS.enc.Utf8);
    div.innerHTML = `<b>${k.name}</b><br>Usuario: ${user}<br>Clave: ${pass}<br>Nota: ${k.note}<br>Etiquetas: ${k.tags.map(t=>'<span class="tag">'+t+'</span>').join(' ')}`;
    const btnEdit = document.createElement('button'); btnEdit.textContent='Editar'; btnEdit.onclick=()=>editKey(i);
    const btnDel = document.createElement('button'); btnDel.textContent='Borrar'; btnDel.onclick=()=>{ dbData.keys.splice(i,1); saveDb(); renderKeys(); };
    const btnDiv = document.createElement('div'); btnDiv.className='flex'; btnDiv.appendChild(btnEdit); btnDiv.appendChild(btnDel);
    div.appendChild(btnDiv);
    listDiv.appendChild(div);
  });
}

document.getElementById('searchKey').addEventListener('input', e=>renderKeys(e.target.value));

function editKey(index) {
  const k = dbData.keys[index];
  document.getElementById('keyName').value = k.name;
  document.getElementById('keyUser').value = CryptoJS.AES.decrypt(k.user, masterKeyGlobal).toString(CryptoJS.enc.Utf8);
  document.getElementById('keyPass').value = CryptoJS.AES.decrypt(k.pass, masterKeyGlobal).toString(CryptoJS.enc.Utf8);
  document.getElementById('keyNote').value = k.note;
  document.getElementById('keyTags').value = k.tags.join(',');
  document.getElementById('saveKeyBtn').onclick = ()=>{ saveKey(index); };
}

function saveKey(index=null) {
  const k = {
    name: document.getElementById('keyName').value,
    user: CryptoJS.AES.encrypt(document.getElementById('keyUser').value, masterKeyGlobal).toString(),
    pass: CryptoJS.AES.encrypt(document.getElementById('keyPass').value, masterKeyGlobal).toString(),
    note: document.getElementById('keyNote').value,
    tags: document.getElementById('keyTags').value.split(',').map(t=>t.trim()).filter(t=>t)
  };
  if(index!==null) dbData.keys[index] = k; else dbData.keys.push(k);
  saveDb();
  clearKeyForm();
  renderKeys();
}

function clearKeyForm() {
  document.getElementById('keyName').value='';
  document.getElementById('keyUser').value='';
  document.getElementById('keyPass').value='';
  document.getElementById('keyNote').value='';
  document.getElementById('keyTags').value='';
  document.getElementById('saveKeyBtn').onclick=()=>saveKey();
}

// --- SAVE DB ---
async function saveDb() {
  const content = CryptoJS.AES.encrypt(JSON.stringify(dbData), masterKeyGlobal).toString();
  const file = new Blob([content], {type:'application/octet-stream'});
  await gapi.client.drive.files.update({ fileId: dbFileId, media:{body:file} });
}

// --- SESSION TIMER ---
function resetSessionTimer() {
  if(sessionTimer) clearTimeout(sessionTimer);
  sessionTimer = setTimeout(()=>{ alert('Sesión expirada'); location.reload(); },5*60*1000);
  ['click','input'].forEach(e=>document.addEventListener(e,resetSessionTimer));
}

// --- EVENTS ---
document.getElementById('createDbBtn').onclick = createDb;

// --- START ---
start();
</script>
</body>
</html>
