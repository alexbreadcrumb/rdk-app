<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Llavero - GIS (GitHub Pages)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f6f8fb;color:#222}
  header{background:#2b7bf6;color:#fff;padding:14px;text-align:center;font-weight:700}
  .wrap{max-width:520px;margin:14px auto;padding:12px}
  button,input,textarea{width:100%;padding:10px;margin:8px 0;box-sizing:border-box;border:1px solid #d0d7e6;border-radius:6px}
  button{background:#2b7bf6;color:#fff;border:0}
  .small{font-size:0.9rem}
  .row{display:flex;gap:8px}
  .row button{flex:1}
  .hint{font-size:0.85rem;color:#555;margin-top:6px}
  .db-btn{display:block;margin:6px 0;padding:10px;text-align:left;border-radius:6px;background:#fff;border:1px solid #e3e6ee}
  .key-item{background:#fff;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9f2}
  .error{color:#9b1b1b;background:#ffdfe0;padding:8px;border-radius:6px}
  .ok{color:#0a6a0a;background:#e2f7e2;padding:8px;border-radius:6px}
  .tags{margin-top:6px}
  .tag{display:inline-block;background:#eee;padding:4px 8px;border-radius:12px;margin-right:6px;font-size:0.8rem}
</style>
</head>
<body>
<header>Llavero (GitHub Pages)</header>
<div class="wrap">
  <div id="statusMsg" class="hint">Estado: esperando acción...</div>

  <div id="loginBlock">
    <button id="btnSign">Iniciar sesión con Google</button>
    <div class="hint">La app pedirá permiso para usar archivos creados por esta app en tu Drive.</div>
  </div>

  <div id="mainPanel" class="hidden">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="newDbName" placeholder="Nombre nuevo archivo (sin .db)" />
      <button id="createDbBtn" style="width:120px">Crear</button>
    </div>

    <input id="masterKey" type="password" placeholder="Clave maestra (para cifrar / desbloquear)" />
    <div id="dbList" style="margin-top:10px"></div>

    <hr/>

    <input id="searchKey" placeholder="Buscar por nombre o texto en nota" />
    <div id="keyList"></div>

    <h4 style="margin-bottom:4px">Agregar / Editar</h4>
    <input id="keyName" placeholder="Nombre de llave" />
    <input id="keyUser" placeholder="Usuario / Mail" />
    <input id="keyPass" placeholder="Clave" />
    <textarea id="keyNote" rows="3" placeholder="Nota"></textarea>
    <input id="keyTags" placeholder="Etiquetas (separadas por coma)" />
    <div class="row">
      <button id="saveKeyBtn">Guardar</button>
      <button id="logoutBtn" style="background:#999">Cerrar sesión</button>
    </div>

    <div id="sessionInfo" class="hint"></div>
  </div>

  <hr/>
  <div class="small hint">
    Recomendaciones: 
    <ul>
      <li>Servir desde <code>https://&lt;tu-usuario&gt;.github.io</code> (no funciona con file://).</li>
      <li>En Google Cloud: habilitar <b>Drive API</b>, configurar OAuth consent y autorizar origenes JS (ej. https://&lt;tu-usuario&gt;.github.io).</li>
    </ul>
    Abrí la consola del navegador (F12) si algo falla y pegá los errores aquí si querés que los revise.
  </div>
</div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- CryptoJS para AES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
/* -------- CONFIG (tu Client ID) -------- */
const CLIENT_ID = '576080826935-2mtnj52ndc8plnsjodjevt3e2gsh4m3a.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
/* -------------------------------------- */

let accessToken = null;
let tokenClient = null;
let dbData = null;
let dbFileId = null;
let masterKey = '';
let sessionTimer = null;

const statusMsg = id('statusMsg');
const btnSign = id('btnSign');
const createDbBtn = id('createDbBtn');
const logoutBtn = id('logoutBtn');

function id(i){ return document.getElementById(i); }
function showStatus(msg, kind = 'info'){
  id('statusMsg').className = kind === 'error' ? 'error' : (kind === 'ok' ? 'ok' : 'hint');
  id('statusMsg').textContent = 'Estado: ' + msg;
  console.log('[STATUS]', msg);
}

window.onload = () => {
  if(!CLIENT_ID || CLIENT_ID.includes('YOUR_')) {
    showStatus('Coloca tu CLIENT_ID en el archivo HTML.', 'error');
    btnSign.disabled = true;
    return;
  }

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (resp) => {
      if(resp.error) {
        showStatus('Error al obtener token: ' + resp.error, 'error');
        console.error('token error', resp);
        return;
      }
      accessToken = resp.access_token;
      showStatus('Autenticado. Token obtenido.', 'ok');
      onSignedIn();
    }
  });

  btnSign.onclick = () => {
    showStatus('Solicitando permisos a Google...');
    try {
      tokenClient.requestAccessToken({prompt: 'consent'});
    } catch(e) {
      showStatus('Error al solicitar token: ' + (e.message || e), 'error');
      console.error(e);
    }
  };
};

async function onSignedIn(){
  id('loginBlock').classList.add('hidden');
  id('mainPanel').classList.remove('hidden');
  id('createDbBtn').onclick = createDb;
  logoutBtn.onclick = signOut;
  id('searchKey').addEventListener('input', e => renderKeys(e.target.value));
  id('saveKeyBtn').onclick = saveKey;
  resetSessionTimer();
  await loadDbList();
}

function signOut(){
  if(accessToken){
    fetch('https://oauth2.googleapis.com/revoke?token=' + accessToken, { method: 'POST', headers: {'Content-type':'application/x-www-form-urlencoded'} })
      .then(()=>{ accessToken = null; location.reload(); })
      .catch(()=> location.reload());
  } else location.reload();
}

async function driveListDbFiles(){
  const q = "mimeType='application/octet-stream' and trashed=false";
  const url = `https://www.googleapis.com/drive/v3/files?pageSize=50&fields=files(id,name,modifiedTime)&q=${encodeURIComponent(q)}&orderBy=modifiedTime desc`;
  const res = await fetch(url, { headers: { Authorization: 'Bearer ' + accessToken }});
  if(!res.ok) throw await res.json();
  return await res.json();
}
async function driveGetFileContent(fileId){
  const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
  const res = await fetch(url, { headers: { Authorization: 'Bearer ' + accessToken }});
  if(!res.ok) throw await res.json();
  return await res.text();
}
async function driveCreateFile(name, blob){
  const metadata = { name, mimeType: 'application/octet-stream' };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', blob);
  const url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id';
  const res = await fetch(url, { method:'POST', headers:{ Authorization: 'Bearer ' + accessToken }, body: form });
  if(!res.ok) throw await res.json();
  return await res.json();
}
async function driveUpdateFileContent(fileId, blob){
  const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
  const res = await fetch(url, { method:'PATCH', headers:{ Authorization: 'Bearer ' + accessToken, 'Content-Type':'application/octet-stream' }, body: blob });
  if(!res.ok) throw await res.json();
  return await res.json();
}

async function loadDbList(){
  try {
    const json = await driveListDbFiles();
    const files = json.files || [];
    const list = id('dbList');
    list.innerHTML = '';
    if(files.length === 0) list.innerHTML = '<div class="hint">No hay archivos .db (creá uno abajo)</div>';
    files.forEach(f=>{
      const btn = document.createElement('button');
      btn.className = 'db-btn';
      btn.textContent = `${f.name} • ${new Date(f.modifiedTime).toLocaleString()}`;
      btn.onclick = () => openDbPrompt(f.id, f.name);
      list.appendChild(btn);
    });
    showStatus('Lista de .db cargada (' + files.length + ').');
  } catch(e){
    showStatus('Error listando archivos: ' + (e.error || e.message || JSON.stringify(e)), 'error');
    console.error('list error', e);
  }
}

async function createDb(){
  const nameBase = id('newDbName').value.trim();
  const key = id('masterKey').value;
  if(!nameBase || !key) return alert('Nombre y clave maestra obligatorios.');
  masterKey = key;
  dbData = { keys: [] };
  try {
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(dbData), masterKey).toString();
    const blob = new Blob([encrypted], { type: 'application/octet-stream' });
    const created = await driveCreateFile(nameBase + '.db', blob);
    dbFileId = created.id;
    showStatus('Archivo creado: ' + nameBase + '.db', 'ok');
    await loadDbList();
    renderKeys();
    resetSessionTimer();
  } catch(e){
    showStatus('Error creando archivo: ' + (e.error || e.message || JSON.stringify(e)), 'error');
    console.error('create error', e);
  }
}

async function openDbPrompt(fileId, fileName){
  const key = prompt('Ingrese clave maestra para ' + fileName);
  if(!key) return;
  masterKey = key;
  try {
    const body = await driveGetFileContent(fileId);
    const decrypted = CryptoJS.AES.decrypt(body, masterKey).toString(CryptoJS.enc.Utf8);
    dbData = JSON.parse(decrypted);
    dbFileId = fileId;
    showStatus('Archivo abierto: ' + fileName, 'ok');
    renderKeys();
    resetSessionTimer();
  } catch(e){
    showStatus('No se pudo abrir archivo (clave incorrecta o error): ' + (e.error || e.message || JSON.stringify(e)), 'error');
    console.error('open error', e);
  }
}

function renderKeys(filter=''){
  const container = id('keyList');
  container.innerHTML = '';
  if(!dbData){ container.innerHTML = '<div class="hint">Abre o crea un .db primero.</div>'; return; }
  const list = dbData.keys.filter(k => {
    if(!filter) return true;
    const f = filter.toLowerCase();
    return (k.name && k.name.toLowerCase().includes(f)) || (k.note && k.note.toLowerCase().includes(f));
  });
  list.forEach((k, idx)=>{
    let user = '(error)'; let pass = '(error)';
    try {
      user = CryptoJS.AES.decrypt(k.user, masterKey).toString(CryptoJS.enc.Utf8);
      pass = CryptoJS.AES.decrypt(k.pass, masterKey).toString(CryptoJS.enc.Utf8);
    } catch(e){ /* placeholders */ }
    const div = document.createElement('div'); div.className = 'key-item';
    div.innerHTML = `<b>${escapeHtml(k.name)}</b>
      <div class="small">Usuario: ${escapeHtml(user)}</div>
      <div class="small">Clave: ${escapeHtml(pass)}</div>
      <div class="small">Nota: ${escapeHtml(k.note||'')}</div>
      <div class="tags">${(k.tags||[]).map(t=>' <span class="tag">'+escapeHtml(t)+'</span>').join('')}</div>`;
    const row = document.createElement('div'); row.className = 'row';
    const editBtn = document.createElement('button'); editBtn.textContent = 'Editar'; editBtn.onclick = ()=> populateEdit(idx);
    const delBtn = document.createElement('button'); delBtn.textContent = 'Borrar'; delBtn.onclick = ()=> { if(confirm('Borrar llave?')) { dbData.keys.splice(idx,1); saveDb(); renderKeys(id('searchKey').value); } };
    row.appendChild(editBtn); row.appendChild(delBtn);
    div.appendChild(row);
    container.appendChild(div);
  });
}

function saveKey(){
  if(!dbData || !dbFileId) return alert('Abre o crea un .db primero.');
  const name = id('keyName').value.trim();
  const user = id('keyUser').value;
  const pass = id('keyPass').value;
  const note = id('keyNote').value;
  const tags = id('keyTags').value.split(',').map(t=>t.trim()).filter(t=>t);
  if(!name) return alert('Nombre de llave obligatorio.');
  const encUser = CryptoJS.AES.encrypt(user, masterKey).toString();
  const encPass = CryptoJS.AES.encrypt(pass, masterKey).toString();

  const editingIndex = dbData.keys.findIndex(k => k._editing === true);
  if(editingIndex >= 0){
    dbData.keys[editingIndex] = { name, user: encUser, pass: encPass, note, tags };
    cleanupEditingFlags();
  } else {
    dbData.keys.push({ name, user: encUser, pass: encPass, note, tags });
  }
  saveDb();
  clearForm();
  renderKeys(id('searchKey').value);
}

function populateEdit(index){
  const k = dbData.keys[index];
  try {
    id('keyName').value = k.name;
    id('keyUser').value = CryptoJS.AES.decrypt(k.user, masterKey).toString(CryptoJS.enc.Utf8);
    id('keyPass').value = CryptoJS.AES.decrypt(k.pass, masterKey).toString(CryptoJS.enc.Utf8);
    id('keyNote').value = k.note;
    id('keyTags').value = (k.tags||[]).join(',');
    cleanupEditingFlags();
    dbData.keys[index]._editing = true;
    showStatus('Editando: ' + k.name);
  } catch(e){
    showStatus('Error al preparar edición: ' + (e.message || e), 'error');
  }
}
function cleanupEditingFlags(){ (dbData.keys||[]).forEach(k=>{ if(k._editing) delete k._editing; }); }
function clearForm(){ id('keyName').value=''; id('keyUser').value=''; id('keyPass').value=''; id('keyNote').value=''; id('keyTags').value=''; }

async function saveDb(){
  try {
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(dbData), masterKey).toString();
    const blob = new Blob([encrypted], { type: 'application/octet-stream' });
    await driveUpdateFileContent(dbFileId, blob);
    showStatus('Guardado en Drive correctamente.', 'ok');
    await loadDbList();
  } catch(e){
    showStatus('Error guardando DB: ' + (e.error || e.message || JSON.stringify(e)), 'error');
    console.error('save error', e);
  }
}

function resetSessionTimer(){
  if(sessionTimer) clearTimeout(sessionTimer);
  sessionTimer = setTimeout(()=>{ alert('Sesión expirada por inactividad.'); location.reload(); }, 5*60*1000);
  ['click','input','keydown','touchstart'].forEach(evt => document.addEventListener(evt, resetSessionTimer));
  const expiresAt = new Date(Date.now() + 5*60*1000);
  id('sessionInfo').textContent = 'Sesión expira a las ' + expiresAt.toLocaleTimeString();
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

id('createDbBtn').onclick = createDb;
id('logoutBtn').onclick = signOut;
</script>
</body>
</html>
